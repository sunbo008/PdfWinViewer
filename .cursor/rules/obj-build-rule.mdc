---
alwaysApply: false
---

# é¡¹ç›®æ„å»ºè§„åˆ™

## ğŸ“‹ æ„å»ºé¡ºåºæ¦‚è§ˆ

**å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹é¡ºåºæ„å»ºé¡¹ç›®ï¼š**

```
1. pdfium (åŸºç¡€é™æ€åº“)
   â†“
2. pdfium_ex (æ‰©å±•é™æ€åº“)
   â†“
3. PdfWinViewer (ä¸»é¡¹ç›®)
```

**ä¸¥æ ¼è¦æ±‚ï¼š**
- âŒ **ç»å¯¹ç¦æ­¢ä½¿ç”¨é¢„æ„å»ºåº“**
- âŒ **ç»å¯¹ç¦æ­¢ä½¿ç”¨ç³»ç»Ÿæˆ–å…¶ä»–ä½ç½®çš„PDFiumåº“**
- âœ… **å¿…é¡»ç”± `third_party/pdfium/` ç›®å½•æ„å»ºé™æ€åº“**
- âœ… **é™æ€åº“è·¯å¾„å¿…é¡»ä¸ºï¼š`third_party/pdfium/out/Debug/obj/libpdfium.a`**
- âš ï¸ **è¿åæ„å»ºé¡ºåºæˆ–è·¯å¾„è¦æ±‚å°†å¯¼è‡´æ„å»ºå¤±è´¥**

---

## 0. ç¼–è¯‘ç¯å¢ƒé…ç½®è¦æ±‚

### 0.1 å¿…éœ€å·¥å…·å’Œç¯å¢ƒ
åœ¨å¼€å§‹æ„å»ºä¹‹å‰ï¼Œå¿…é¡»ç¡®ä¿ä»¥ä¸‹å·¥å…·å·²æ­£ç¡®å®‰è£…å’Œé…ç½®ï¼š

#### å¿…éœ€å·¥å…·æ¸…å•ï¼š
- **GN (Generate Ninja)**: PDFiumæ„å»ºç³»ç»Ÿ
- **Ninja**: å¿«é€Ÿæ„å»ºå·¥å…·
- **Clang/GCC**: C++ç¼–è¯‘å™¨ï¼ˆæ”¯æŒC++17æ ‡å‡†ï¼‰
- **Python 3**: æ„å»ºè„šæœ¬ä¾èµ–
- **Git**: æºä»£ç ç®¡ç†
- **CMake**: ä¸»é¡¹ç›®æ„å»ºç³»ç»Ÿ

#### macOS ç¯å¢ƒé…ç½®ï¼š
```bash
# å®‰è£… Xcode Command Line Tools
xcode-select --install

# å®‰è£… depot_tools (åŒ…å« gn å’Œ ninja)
git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
export PATH="$PWD/depot_tools:$PATH"

# éªŒè¯å·¥å…·å®‰è£…
gn --version
ninja --version
clang --version
```

### 0.2 ç¯å¢ƒå˜é‡é…ç½®
```bash
# è®¾ç½®æ„å»ºç¯å¢ƒå˜é‡
export CC=clang
export CXX=clang++
export AR=ar
export RANLIB=ranlib

# PDFium ç‰¹å®šç¯å¢ƒå˜é‡
export DEPOT_TOOLS_UPDATE=0
export DEPOT_TOOLS_WIN_TOOLCHAIN=0
```

### 0.3 é¢„æ„å»ºåº“æ£€æŸ¥å’Œæ¸…ç†
**ç»å¯¹ç¦æ­¢ä½¿ç”¨ä»»ä½•é¢„æ„å»ºåº“ï¼**

#### å¼ºåˆ¶æ£€æŸ¥è§„åˆ™ï¼š
```bash
# æ£€æŸ¥å¹¶åˆ é™¤ä»»ä½•å¯èƒ½å­˜åœ¨çš„é¢„æ„å»ºåº“
find . -name "*.dylib" -o -name "*.so" -o -name "*.dll" | grep -i pdfium
find . -name "libpdfium*" -not -path "*/out/Debug/obj/*"

# å¦‚æœå‘ç°é¢„æ„å»ºåº“æ–‡ä»¶ï¼Œå¿…é¡»åˆ é™¤
rm -f third_party/pdfium/lib/*
rm -f third_party/pdfium/bin/*
rm -rf third_party/pdfium/prebuilt/
```

#### æºä»£ç å®Œæ•´æ€§éªŒè¯ï¼š
```bash
# éªŒè¯ PDFium æºä»£ç å®Œæ•´æ€§
cd third_party/pdfium
git status
git log --oneline -5

# ç¡®ä¿æ‰€æœ‰æºæ–‡ä»¶å­˜åœ¨
ls -la public/fpdfview.h
ls -la core/
ls -la fpdfsdk/
```

## 1. Debugç‰ˆæœ¬æ„å»ºè§„åˆ™

åœ¨æ„å»ºæ­¤é¡¹ç›®æ—¶ï¼Œå¿…é¡»éµå¾ªä»¥ä¸‹debugç‰ˆæœ¬æ„å»ºè§„åˆ™ï¼š

- ä½¿ç”¨ Debug é…ç½®è¿›è¡Œç¼–è¯‘ï¼Œç¡®ä¿åŒ…å«è°ƒè¯•ä¿¡æ¯
- å¯ç”¨æ‰€æœ‰è°ƒè¯•ç¬¦å·å’Œæ–­è¨€
- ç¦ç”¨ä¼˜åŒ–ä»¥ä¾¿äºè°ƒè¯•
- åœ¨ CMake ä¸­ä½¿ç”¨ `CMAKE_BUILD_TYPE=Debug`
- ç¼–è¯‘å™¨æ ‡å¿—åº”åŒ…å« `-g` (GCC/Clang) æˆ– `/Zi` (MSVC) ç”¨äºè°ƒè¯•ä¿¡æ¯
- ç¡®ä¿é“¾æ¥å™¨ç”Ÿæˆè°ƒè¯•ä¿¡æ¯

## 2. PDFium å•ä¸€é™æ€åº“æ„å»ºè§„åˆ™

PDFium å¿…é¡»æ„å»ºä¸ºå•ä¸€çš„é™æ€åº“æ–‡ä»¶ï¼Œæ–¹ä¾¿é“¾æ¥å’Œéƒ¨ç½²ï¼š

### 2.1 ä¸¥æ ¼æ„å»ºè·¯å¾„è¦æ±‚

**ç»å¯¹è·¯å¾„è¦æ±‚ - ä¸å¯æ›´æ”¹ï¼š**
- **æºä»£ç ä½ç½®**ï¼šå¿…é¡»ä½¿ç”¨ `third_party/pdfium/` ç›®å½•ä¸‹çš„æºä»£ç 
- **æ„å»ºç›®å½•**ï¼šå¿…é¡»åœ¨ `third_party/pdfium/out/Debug/` ç›®å½•æ„å»º
- **é™æ€åº“è¾“å‡º**ï¼šå¿…é¡»ç”Ÿæˆ `third_party/pdfium/out/Debug/obj/libpdfium.a`
- **é…ç½®æ–‡ä»¶ä½ç½®**ï¼šå¿…é¡»åœ¨ `third_party/pdfium/out/Debug/args.gn`

**ä¸¥æ ¼ç¦æ­¢çš„è¡Œä¸ºï¼š**
- âŒ **ç¦æ­¢ä½¿ç”¨é¢„æ„å»ºçš„ PDFium åº“æ–‡ä»¶**
- âŒ **ç¦æ­¢ä»å…¶ä»–ç›®å½•å¤åˆ¶æˆ–ç§»åŠ¨PDFiumæºä»£ç **
- âŒ **ç¦æ­¢ä¿®æ”¹æ„å»ºè¾“å‡ºè·¯å¾„**
- âŒ **ç¦æ­¢ä½¿ç”¨ç³»ç»Ÿå®‰è£…çš„PDFium**
- âŒ **ç¦æ­¢ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…çš„PDFium**

**å¼ºåˆ¶è¦æ±‚ï¼š**
- âœ… ä½¿ç”¨ GN (Generate Ninja) æ„å»ºç³»ç»Ÿæ„å»º PDFium
- âœ… **å¿…é¡»æ„å»ºä¸ºå•ä¸€çš„é™æ€åº“æ–‡ä»¶**
- âœ… **é™æ€åº“å¿…é¡»ä½äºæŒ‡å®šçš„ç²¾ç¡®è·¯å¾„**

### 2.2 å¼ºåˆ¶é™æ€åº“é…ç½®
**å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹é…ç½®æ„å»ºï¼Œç¡®ä¿ç”Ÿæˆå•ä¸€é™æ€åº“ï¼š**

#### å®Œæ•´çš„ args.gn é…ç½®æ–‡ä»¶ï¼š
```gn
# ============================================
# PDFium é™æ€åº“æ„å»ºé…ç½® - ä¸¥æ ¼æ‰§è¡Œ
# ============================================

# Debug æ„å»ºé…ç½® - å¿…éœ€
is_debug = true
symbol_level = 2
is_official_build = false

# é™æ€åº“é…ç½® - æ ¸å¿ƒè¦æ±‚
is_component_build = false
pdf_is_standalone = true
pdf_is_complete_lib = true
use_static_libs = true

# ç¦ç”¨æ‰€æœ‰åŠ¨æ€ä¾èµ– - ç¡®ä¿é™æ€é“¾æ¥
use_custom_libcxx = false
use_system_freetype = false
use_system_libjpeg = false
use_system_libpng = false
use_system_zlib = false

# åŠŸèƒ½é…ç½® - ç®€åŒ–ä¾èµ–
pdf_use_skia = false
pdf_enable_xfa = false
pdf_enable_v8 = false
pdf_use_partition_alloc = false

# å¹³å°é…ç½®
target_os = "mac"
target_cpu = "arm64"  # æˆ– "x64" æ ¹æ®ç›®æ ‡å¹³å°

# å¼ºåˆ¶é™æ€åº“æ‰“åŒ… - å…³é”®é…ç½®
pdf_bundle_freetype = true
pdf_bundle_libjpeg = true
pdf_bundle_libpng = true
pdf_bundle_zlib = true
pdf_bundle_lcms2 = true
pdf_bundle_libopenjpeg2 = true

# ç¼–è¯‘å™¨é…ç½®
treat_warnings_as_errors = false
use_thin_lto = false
use_lld = false

# ç¡®ä¿æ‰€æœ‰ä¾èµ–éƒ½é™æ€é“¾æ¥
link_pool_depth = 1
```

#### é…ç½®éªŒè¯è¦æ±‚ï¼š
- **å¿…é¡»æ£€æŸ¥** `is_component_build = false`
- **å¿…é¡»æ£€æŸ¥** `pdf_is_complete_lib = true`
- **å¿…é¡»æ£€æŸ¥** æ‰€æœ‰ `pdf_bundle_*` é€‰é¡¹éƒ½ä¸º `true`
- **ç¦æ­¢** ä»»ä½• `use_system_*` é€‰é¡¹ä¸º `true`

### 2.3 æ„å»ºè¾“å‡ºè¦æ±‚
- æ„å»ºå®Œæˆåï¼Œå¿…é¡»ç”Ÿæˆå•ä¸€çš„é™æ€åº“æ–‡ä»¶ï¼š`libpdfium.a`
- é™æ€åº“æ–‡ä»¶ä½äº `third_party/pdfium/out/Debug/obj/` ç›®å½•
- è¯¥é™æ€åº“åº”åŒ…å«æ‰€æœ‰PDFiumåŠŸèƒ½ï¼Œæ— éœ€é¢å¤–ä¾èµ–åº“
- ä¸»é¡¹ç›®åªéœ€é“¾æ¥è¿™ä¸€ä¸ªé™æ€åº“æ–‡ä»¶å³å¯

### 2.4 ä¸¥æ ¼è·¯å¾„å’Œå†…å®¹éªŒè¯

**æ„å»ºå®Œæˆåå¿…é¡»é€šè¿‡ä»¥ä¸‹æ‰€æœ‰éªŒè¯ï¼š**

#### è·¯å¾„éªŒè¯ï¼ˆä¸¥æ ¼è¦æ±‚ï¼‰ï¼š
```bash
# 1. éªŒè¯é™æ€åº“æ–‡ä»¶å¿…é¡»åœ¨æŒ‡å®šä½ç½®
EXPECTED_PATH="third_party/pdfium/out/Debug/obj/libpdfium.a"
if [ ! -f "${EXPECTED_PATH}" ]; then
    echo "âŒ é”™è¯¯ï¼šé™æ€åº“ä¸åœ¨è¦æ±‚çš„è·¯å¾„ï¼š${EXPECTED_PATH}"
    exit 1
fi

# 2. éªŒè¯æ„å»ºç›®å½•ç»“æ„
if [ ! -d "third_party/pdfium/out/Debug" ]; then
    echo "âŒ é”™è¯¯ï¼šæ„å»ºç›®å½•ä¸å­˜åœ¨ï¼šthird_party/pdfium/out/Debug"
    exit 1
fi

# 3. éªŒè¯é…ç½®æ–‡ä»¶ä½ç½®
if [ ! -f "third_party/pdfium/out/Debug/args.gn" ]; then
    echo "âŒ é”™è¯¯ï¼šé…ç½®æ–‡ä»¶ä¸åœ¨è¦æ±‚ä½ç½®ï¼šthird_party/pdfium/out/Debug/args.gn"
    exit 1
fi
```

#### å†…å®¹éªŒè¯ï¼š
```bash
# 4. éªŒè¯åº“æ–‡ä»¶å¤§å°ï¼ˆå¿…é¡» > 50MBï¼‰
SIZE=$(stat -f%z "${EXPECTED_PATH}" 2>/dev/null || stat -c%s "${EXPECTED_PATH}")
if [ "$SIZE" -lt 52428800 ]; then
    echo "âŒ é”™è¯¯ï¼šåº“æ–‡ä»¶å¤§å°å¼‚å¸¸ï¼š$(($SIZE / 1024 / 1024))MB < 50MB"
    exit 1
fi

# 5. éªŒè¯æ˜¯å¦ä¸ºé™æ€åº“æ ¼å¼
file "${EXPECTED_PATH}" | grep -q "ar archive" || {
    echo "âŒ é”™è¯¯ï¼šæ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„é™æ€åº“æ ¼å¼"
    exit 1
}

# 6. éªŒè¯å¿…è¦çš„PDFiumç¬¦å·
REQUIRED_SYMBOLS="FPDF_InitLibrary FPDF_LoadDocument FPDF_GetPageCount"
for symbol in $REQUIRED_SYMBOLS; do
    if ! nm "${EXPECTED_PATH}" | grep -q "$symbol"; then
        echo "âŒ é”™è¯¯ï¼šç¼ºå°‘å¿…è¦ç¬¦å·ï¼š$symbol"
        exit 1
    fi
done
```

#### æºä»£ç éªŒè¯ï¼š
```bash
# 7. éªŒè¯æºä»£ç å®Œæ•´æ€§
if [ ! -f "third_party/pdfium/public/fpdfview.h" ]; then
    echo "âŒ é”™è¯¯ï¼šPDFiumæºä»£ç ä¸å®Œæ•´"
    exit 1
fi
```

## 3. æ„å»ºæµç¨‹å’Œå‘½ä»¤

### 3.1 å®Œæ•´æ„å»ºæµç¨‹ï¼ˆä¸¥æ ¼æ‰§è¡Œï¼‰

#### ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒæ£€æŸ¥å’Œå‡†å¤‡
```bash
# 1. æ£€æŸ¥å¿…éœ€å·¥å…·
echo "æ£€æŸ¥æ„å»ºå·¥å…·..."
which gn || { echo "é”™è¯¯: GN æœªå®‰è£…"; exit 1; }
which ninja || { echo "é”™è¯¯: Ninja æœªå®‰è£…"; exit 1; }
which clang || { echo "é”™è¯¯: Clang æœªå®‰è£…"; exit 1; }

# 2. è®¾ç½®ç¯å¢ƒå˜é‡
export CC=clang
export CXX=clang++
export AR=ar
export RANLIB=ranlib
export DEPOT_TOOLS_UPDATE=0

# 3. æ¸…ç†é¢„æ„å»ºåº“ï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰
echo "æ¸…ç†å¯èƒ½å­˜åœ¨çš„é¢„æ„å»ºåº“..."
find . -name "*.dylib" -o -name "*.so" -o -name "*.dll" | grep -i pdfium | xargs rm -f
rm -rf third_party/pdfium/lib/ third_party/pdfium/bin/ third_party/pdfium/prebuilt/

# 4. å¼ºåˆ¶è·¯å¾„éªŒè¯å¹¶è¿›å…¥PDFiumç›®å½•
REQUIRED_PDFIUM_DIR="third_party/pdfium"
if [ ! -d "${REQUIRED_PDFIUM_DIR}" ]; then
    echo "âŒ é”™è¯¯ï¼šPDFiumæºä»£ç ç›®å½•ä¸å­˜åœ¨ï¼š${REQUIRED_PDFIUM_DIR}"
    exit 1
fi

# éªŒè¯å…³é”®æºæ–‡ä»¶å­˜åœ¨
if [ ! -f "${REQUIRED_PDFIUM_DIR}/public/fpdfview.h" ]; then
    echo "âŒ é”™è¯¯ï¼šPDFiumæ ¸å¿ƒå¤´æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæºä»£ç å¯èƒ½ä¸å®Œæ•´"
    exit 1
fi

cd "${REQUIRED_PDFIUM_DIR}"
echo "âœ… å·²è¿›å…¥PDFiumæºä»£ç ç›®å½•ï¼š$(pwd)"
```

#### ç¬¬äºŒæ­¥ï¼šé…ç½®æ„å»ºå‚æ•°
```bash
# 1. åˆ›å»ºæ„å»ºç›®å½•
mkdir -p out/Debug

# 2. åˆ›å»º args.gn é…ç½®æ–‡ä»¶
cat > out/Debug/args.gn << 'EOF'
# PDFium é™æ€åº“æ„å»ºé…ç½® - ä¸¥æ ¼æ‰§è¡Œ
is_debug = true
symbol_level = 2
is_official_build = false
is_component_build = false
pdf_is_standalone = true
pdf_is_complete_lib = true
use_static_libs = true
use_custom_libcxx = false
use_system_freetype = false
use_system_libjpeg = false
use_system_libpng = false
use_system_zlib = false
pdf_use_skia = false
pdf_enable_xfa = false
pdf_enable_v8 = false
pdf_use_partition_alloc = false
target_os = "mac"
target_cpu = "arm64"
pdf_bundle_freetype = true
pdf_bundle_libjpeg = true
pdf_bundle_libpng = true
pdf_bundle_zlib = true
pdf_bundle_lcms2 = true
pdf_bundle_libopenjpeg2 = true
treat_warnings_as_errors = false
use_thin_lto = false
use_lld = false
link_pool_depth = 1
EOF

# 3. éªŒè¯é…ç½®æ–‡ä»¶
echo "éªŒè¯ args.gn é…ç½®..."
cat out/Debug/args.gn
```

#### ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆæ„å»ºæ–‡ä»¶
```bash
# ç”Ÿæˆ Ninja æ„å»ºæ–‡ä»¶
echo "ç”Ÿæˆæ„å»ºæ–‡ä»¶..."
gn gen out/Debug

# æ£€æŸ¥ç”Ÿæˆç»“æœ
if [ $? -ne 0 ]; then
    echo "é”™è¯¯: GN ç”Ÿæˆå¤±è´¥"
    exit 1
fi
```

#### ç¬¬å››æ­¥ï¼šæ‰§è¡Œæ„å»º
```bash
# å¼€å§‹æ„å»º PDFium é™æ€åº“
echo "å¼€å§‹æ„å»º PDFium é™æ€åº“..."
ninja -C out/Debug pdfium

# æ£€æŸ¥æ„å»ºç»“æœ
if [ $? -ne 0 ]; then
    echo "é”™è¯¯: æ„å»ºå¤±è´¥"
    exit 1
fi
```

#### ç¬¬äº”æ­¥ï¼šä¸¥æ ¼éªŒè¯æ„å»ºç»“æœ
```bash
# 1. å¼ºåˆ¶è·¯å¾„éªŒè¯ - é™æ€åº“å¿…é¡»åœ¨æŒ‡å®šä½ç½®
REQUIRED_LIBFILE="out/Debug/obj/libpdfium.a"
ABSOLUTE_LIBFILE="${PWD}/${REQUIRED_LIBFILE}"

if [ ! -f "${REQUIRED_LIBFILE}" ]; then
    echo "âŒ é”™è¯¯ï¼šé™æ€åº“æ–‡ä»¶ä¸åœ¨è¦æ±‚ä½ç½®ï¼š${REQUIRED_LIBFILE}"
    echo "å½“å‰ç›®å½•ï¼š$(pwd)"
    echo "æœŸæœ›è·¯å¾„ï¼š${ABSOLUTE_LIBFILE}"
    exit 1
fi

# éªŒè¯æˆ‘ä»¬ç¡®å®åœ¨æ­£ç¡®çš„PDFiumç›®å½•ä¸­
if [[ "$(pwd)" != *"third_party/pdfium" ]]; then
    echo "âŒ é”™è¯¯ï¼šä¸åœ¨æ­£ç¡®çš„PDFiumæºä»£ç ç›®å½•ä¸­"
    echo "å½“å‰ç›®å½•ï¼š$(pwd)"
    exit 1
fi

# 2. éªŒè¯æ–‡ä»¶ç±»å‹
echo "éªŒè¯åº“æ–‡ä»¶ç±»å‹..."
file "${REQUIRED_LIBFILE}"

# 3. æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆåº”è¯¥ > 50MBï¼‰
SIZE=$(stat -f%z "${REQUIRED_LIBFILE}" 2>/dev/null || stat -c%s "${REQUIRED_LIBFILE}")
if [ "$SIZE" -lt 52428800 ]; then  # 50MB
    echo "âŒ é”™è¯¯ï¼šåº“æ–‡ä»¶å¤§å°å¼‚å¸¸ï¼š$(($SIZE / 1024 / 1024))MB < 50MB"
    exit 1
fi

# 4. éªŒè¯ç¬¦å·è¡¨
echo "éªŒè¯ç¬¦å·è¡¨..."
nm "${REQUIRED_LIBFILE}" | grep -E "(FPDF_|PDF_)" | head -10

# 5. æ£€æŸ¥æ˜¯å¦åŒ…å«å¿…è¦çš„ç¬¦å·
REQUIRED_SYMBOLS="FPDF_InitLibrary FPDF_LoadDocument FPDF_GetPageCount"
for symbol in $REQUIRED_SYMBOLS; do
    if ! nm "${REQUIRED_LIBFILE}" | grep -q "$symbol"; then
        echo "âŒ é”™è¯¯ï¼šç¼ºå°‘å¿…è¦ç¬¦å·ï¼š$symbol"
        exit 1
    fi
done

# 6. æœ€ç»ˆè·¯å¾„ç¡®è®¤
echo "âœ… PDFium é™æ€åº“æ„å»ºæˆåŠŸï¼"
echo "ğŸ“ åº“æ–‡ä»¶ä½ç½®ï¼š${ABSOLUTE_LIBFILE}"
echo "ğŸ“Š æ–‡ä»¶å¤§å°ï¼š$(($SIZE / 1024 / 1024))MB"
echo "ğŸ” æ„å»ºç›®å½•ï¼š$(pwd)"
```

### 3.2 ä¸»é¡¹ç›®æ„å»ºé…ç½®

**æ³¨æ„ï¼šé¡¹ç›®å·²æœ‰å®Œå–„çš„CMakeLists.txté…ç½®ï¼Œè¯·å‹¿éšæ„ä¿®æ”¹ï¼**

#### å½“å‰é¡¹ç›®çš„é“¾æ¥é…ç½®ï¼ˆå·²å­˜åœ¨ï¼Œæ— éœ€ä¿®æ”¹ï¼‰ï¼š
é¡¹ç›®ä½¿ç”¨ `PDFIUM_STATIC` å˜é‡æ¥æŒ‡å®šé™æ€åº“è·¯å¾„ï¼Œè¿™æ˜¯æ­£ç¡®çš„è®¾è®¡ã€‚

#### æ„å»ºä¸»é¡¹ç›®æ—¶çš„æ­£ç¡®å‘½ä»¤ï¼š
```bash
# å›åˆ°é¡¹ç›®æ ¹ç›®å½•
cd /Users/wps/work/WorkSpace/github/PdfWinViewer

# åˆ›å»ºæ„å»ºç›®å½•
mkdir -p build && cd build

# é…ç½®é¡¹ç›®ï¼ŒæŒ‡å®šPDFiumé™æ€åº“è·¯å¾„
cmake .. -DCMAKE_BUILD_TYPE=Debug \
         -DPDFIUM_STATIC=/Users/wps/work/WorkSpace/github/PdfWinViewer/third_party/pdfium/out/Debug/obj/libpdfium.a

# æ„å»ºé¡¹ç›®
cmake --build . --config Debug
```

#### éªŒè¯é“¾æ¥é…ç½®ï¼š
```bash
# æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶çš„é“¾æ¥ä¾èµ–
otool -L PdfWinViewer.app/Contents/MacOS/PdfWinViewer

# ç¡®è®¤æ²¡æœ‰åŠ¨æ€é“¾æ¥åˆ°PDFium
otool -L PdfWinViewer.app/Contents/MacOS/PdfWinViewer | grep -i pdfium
# ä¸Šè¿°å‘½ä»¤åº”è¯¥æ²¡æœ‰è¾“å‡ºï¼Œè¡¨ç¤ºPDFiumå·²é™æ€é“¾æ¥
```

### 3.3 å¼ºåˆ¶æ„å»ºé¡ºåºè¦æ±‚

**å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹é¡ºåºæ„å»ºé¡¹ç›®ç»„ä»¶ï¼š**

#### æ„å»ºé¡ºåºï¼špdfium â†’ pdfium_ex â†’ PdfWinViewer

1. **ç¬¬ä¸€æ­¥ï¼šæ„å»º PDFium é™æ€åº“**
   ```bash
   cd third_party/pdfium
   # æŒ‰ç…§å‰è¿°æ­¥éª¤æ„å»º libpdfium.a
   ninja -C out/Debug pdfium
   ```
   - **è¾“å‡º**ï¼š`third_party/pdfium/out/Debug/obj/libpdfium.a`
   - **éªŒè¯**ï¼šç¡®è®¤æ–‡ä»¶å­˜åœ¨ä¸”å¤§å° > 50MB

2. **ç¬¬äºŒæ­¥ï¼šæ„å»º PDFium æ‰©å±•åº“ (pdfium_ex)**
   ```bash
   cd third_party/pdfium_ex
   mkdir -p build && cd build
   cmake .. -DCMAKE_BUILD_TYPE=Debug
   cmake --build . --config Debug
   ```
   - **è¾“å‡º**ï¼š`third_party/pdfium_ex/build/libpdfium_ex.a`
   - **ä¾èµ–**ï¼šéœ€è¦ç¬¬ä¸€æ­¥çš„ PDFium é™æ€åº“

3. **ç¬¬ä¸‰æ­¥ï¼šæ„å»ºä¸»é¡¹ç›® (PdfWinViewer)**
   ```bash
   cd /Users/wps/work/WorkSpace/github/PdfWinViewer
   mkdir -p build && cd build
   cmake .. -DCMAKE_BUILD_TYPE=Debug \
            -DPDFIUM_STATIC=/Users/wps/work/WorkSpace/github/PdfWinViewer/third_party/pdfium/out/Debug/obj/libpdfium.a
   cmake --build . --config Debug
   ```
   - **è¾“å‡º**ï¼š`build/PdfWinViewer.app`
   - **ä¾èµ–**ï¼šéœ€è¦å‰ä¸¤æ­¥çš„é™æ€åº“

#### æ„å»ºé¡ºåºçš„é‡è¦æ€§ï¼š

- **pdfium** æ˜¯åŸºç¡€åº“ï¼Œæ‰€æœ‰å…¶ä»–ç»„ä»¶éƒ½ä¾èµ–å®ƒ
- **pdfium_ex** æ‰©å±•åº“ä¾èµ–äº pdfiumï¼Œæä¾›é¢å¤–åŠŸèƒ½
- **PdfWinViewer** ä¸»é¡¹ç›®ä¾èµ–äºå‰ä¸¤è€…ï¼Œæ˜¯æœ€ç»ˆçš„å¯æ‰§è¡Œç¨‹åº

#### è¿åæ„å»ºé¡ºåºçš„åæœï¼š
- âŒ è·³è¿‡ pdfium æ„å»º â†’ ç¼ºå°‘åŸºç¡€é™æ€åº“
- âŒ è·³è¿‡ pdfium_ex æ„å»º â†’ é“¾æ¥æ—¶æ‰¾ä¸åˆ°æ‰©å±•åº“
- âŒ é¢ å€’æ„å»ºé¡ºåº â†’ ä¾èµ–å…³ç³»é”™è¯¯ï¼Œæ„å»ºå¤±è´¥

#### éªŒè¯æ¯ä¸ªæ­¥éª¤ï¼š
```bash
# éªŒè¯ pdfium
ls -la third_party/pdfium/out/Debug/obj/libpdfium.a

# éªŒè¯ pdfium_ex
ls -la third_party/pdfium_ex/build/libpdfium_ex.a

# éªŒè¯ä¸»é¡¹ç›®
ls -la build/PdfWinViewer.app/Contents/MacOS/PdfWinViewer
```

## 4. é¡¹ç›®é›†æˆæ³¨æ„äº‹é¡¹

### 4.1 ä¸ç°æœ‰é¡¹ç›®è®¾è®¡çš„å…¼å®¹æ€§

**é‡è¦ï¼šæœ¬é¡¹ç›®å·²æœ‰å®Œå–„çš„æ„å»ºç³»ç»Ÿè®¾è®¡ï¼Œè¯·ä¸¥æ ¼éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š**

#### ä¸è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼š
- âŒ **ä¸è¦ä¿®æ”¹ `CMakeLists.txt` ä¸­çš„é“¾æ¥é…ç½®**
- âŒ **ä¸è¦ä¿®æ”¹ `platform/mac/App.mm` ä¸­çš„å¤´æ–‡ä»¶å¼•ç”¨**
- âŒ **ä¸è¦ä¿®æ”¹ `third_party/pdfium_ex/` æ‰©å±•åº“é…ç½®**

#### é¡¹ç›®ç‰¹å®šçš„æ„å»ºè¦æ±‚ï¼š
- âœ… **å¿…é¡»ä½¿ç”¨ `-DPDFIUM_STATIC` å‚æ•°æŒ‡å®šé™æ€åº“è·¯å¾„**
- âœ… **é™æ€åº“è·¯å¾„å¿…é¡»æ˜¯ç»å¯¹è·¯å¾„**
- âœ… **å¿…é¡»å…ˆæ„å»º `third_party/pdfium_ex` æ‰©å±•åº“**
- âœ… **ä¿æŒç°æœ‰çš„æ¡†æ¶é“¾æ¥é…ç½®ä¸å˜**

#### ç°æœ‰é¡¹ç›®çš„ä¼˜ç§€è®¾è®¡ï¼š
1. **æ™ºèƒ½è·¯å¾„æ£€æµ‹**ï¼šé¡¹ç›®ä¼šè‡ªåŠ¨æ£€æµ‹PDFiumå¤´æ–‡ä»¶ä½ç½®
2. **æ‰©å±•åº“æ”¯æŒ**ï¼šé›†æˆäº† `pdfium_ex` æ‰©å±•åŠŸèƒ½
3. **å®Œæ•´ä¾èµ–å¤„ç†**ï¼šè‡ªåŠ¨å¤„ç† libc++ã€libc++abi ç­‰ä¾èµ–
4. **è·¨å¹³å°å…¼å®¹**ï¼šWindowså’ŒmacOSæœ‰ä¸åŒçš„é“¾æ¥ç­–ç•¥

### 4.2 æ„å»ºPDFiumé™æ€åº“çš„é¡¹ç›®ç‰¹å®šé…ç½®

åŸºäºé¡¹ç›®éœ€æ±‚ï¼ŒPDFiumæ„å»ºé…ç½®éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼š

```gn
# é¡¹ç›®ç‰¹å®šé…ç½® - å¿…é¡»åŒ…å«
target_cpu = "arm64"  # æ ¹æ®æ‚¨çš„Macæ¶æ„è°ƒæ•´
pdf_is_complete_lib = true  # å…³é”®ï¼šç”Ÿæˆå®Œæ•´é™æ€åº“
pdf_bundle_freetype = true  # é¡¹ç›®éœ€è¦çš„å­—ä½“æ”¯æŒ
```

### 4.3 éªŒè¯é¡¹ç›®é›†æˆ

æ„å»ºå®Œæˆåï¼ŒéªŒè¯é¡¹ç›®é›†æˆæ˜¯å¦æ­£ç¡®ï¼š

```bash
# 1. éªŒè¯PDFiumæ‰©å±•åº“
ls -la third_party/pdfium_ex/build/

# 2. éªŒè¯ä¸»é¡¹ç›®æ„å»º
cd build
make VERBOSE=1 | grep -i pdfium

# 3. éªŒè¯æœ€ç»ˆå¯æ‰§è¡Œæ–‡ä»¶
otool -L PdfWinViewer.app/Contents/MacOS/PdfWinViewer
```

## 5. å…³é”®è¦æ±‚æ€»ç»“

### 5.1 ç»å¯¹ç¦æ­¢äº‹é¡¹
- âŒ **ç»å¯¹ç¦æ­¢ä½¿ç”¨ä»»ä½•é¢„æ„å»ºçš„ PDFium åº“æ–‡ä»¶**
- âŒ **ç¦æ­¢ä½¿ç”¨ç³»ç»Ÿå®‰è£…çš„ PDFium åº“**
- âŒ **ç¦æ­¢ä¸‹è½½é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶**
- âŒ **ç¦æ­¢ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…çš„ PDFium**
- âŒ **ç¦æ­¢è·³è¿‡æºä»£ç ç¼–è¯‘æ­¥éª¤**
- âŒ **ç¦æ­¢ä¿®æ”¹é¡¹ç›®ç°æœ‰çš„CMakeLists.txté“¾æ¥é…ç½®**
- âŒ **ç¦æ­¢ä»é `third_party/pdfium/` ç›®å½•æ„å»ºé™æ€åº“**
- âŒ **ç¦æ­¢ä¿®æ”¹é™æ€åº“è¾“å‡ºè·¯å¾„**
- âŒ **ç¦æ­¢å¤åˆ¶æˆ–ç§»åŠ¨PDFiumæºä»£ç åˆ°å…¶ä»–ä½ç½®**

### 5.2 å¼ºåˆ¶è·¯å¾„å’Œæ„å»ºè¦æ±‚
- âœ… **å¿…é¡»ä» `third_party/pdfium/` æºä»£ç ç›®å½•æ„å»º**
- âœ… **é™æ€åº“å¿…é¡»è¾“å‡ºåˆ° `third_party/pdfium/out/Debug/obj/libpdfium.a`**
- âœ… **é…ç½®æ–‡ä»¶å¿…é¡»ä½äº `third_party/pdfium/out/Debug/args.gn`**
- âœ… **å¿…é¡»ç”Ÿæˆå•ä¸€çš„å®Œæ•´é™æ€åº“æ–‡ä»¶**
- âœ… **å¿…é¡»ä½¿ç”¨æä¾›çš„ç²¾ç¡® args.gn é…ç½®**
- âœ… **å¿…é¡»é€šè¿‡æ‰€æœ‰è·¯å¾„å’Œå†…å®¹éªŒè¯æ­¥éª¤**
- âœ… **å¿…é¡»ç¡®ä¿åº“æ–‡ä»¶å¤§å° > 50MB**
- âœ… **å¿…é¡»åŒ…å«æ‰€æœ‰å¿…è¦çš„ FPDF_ ç¬¦å·**
- âœ… **å¿…é¡»ä½¿ç”¨ `-DPDFIUM_STATIC` å‚æ•°æ„å»ºä¸»é¡¹ç›®**

### 5.3 æ„å»ºæˆåŠŸæ ‡å‡†
æ„å»ºå®Œæˆåï¼Œå¿…é¡»æ»¡è¶³ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶ï¼š

1. **æ–‡ä»¶å­˜åœ¨**: `third_party/pdfium/out/Debug/obj/libpdfium.a` å­˜åœ¨
2. **æ–‡ä»¶å¤§å°**: åº“æ–‡ä»¶å¤§å° > 50MB
3. **ç¬¦å·å®Œæ•´**: åŒ…å« `FPDF_InitLibrary`, `FPDF_LoadDocument`, `FPDF_GetPageCount` ç­‰ç¬¦å·
4. **é™æ€é“¾æ¥**: åº“æ–‡ä»¶ä¸ºé™æ€åº“æ ¼å¼ï¼ˆ.a æ–‡ä»¶ï¼‰
5. **æ— åŠ¨æ€ä¾èµ–**: ä¸ä¾èµ–ä»»ä½•å¤–éƒ¨åŠ¨æ€åº“
6. **é¡¹ç›®é›†æˆ**: ä¸»é¡¹ç›®èƒ½å¤ŸæˆåŠŸé“¾æ¥å¹¶è¿è¡Œ

### 5.4 æ•…éšœæ’é™¤
å¦‚æœæ„å»ºå¤±è´¥ï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºæ£€æŸ¥ï¼š

1. **ç¯å¢ƒæ£€æŸ¥**: ç¡®è®¤æ‰€æœ‰å¿…éœ€å·¥å…·å·²å®‰è£…
2. **é…ç½®æ£€æŸ¥**: éªŒè¯ args.gn é…ç½®æ­£ç¡®
3. **æ¸…ç†é‡è¯•**: åˆ é™¤ out/Debug ç›®å½•ï¼Œé‡æ–°æ„å»º
4. **æºä»£ç æ£€æŸ¥**: ç¡®è®¤ PDFium æºä»£ç å®Œæ•´
5. **æƒé™æ£€æŸ¥**: ç¡®è®¤æœ‰å†™å…¥æƒé™

**è®°ä½ï¼šç»å¯¹ä¸èƒ½ä½¿ç”¨é¢„æ„å»ºåº“ï¼å¿…é¡»ä»æºä»£ç æ„å»ºï¼**

## 6. å®Œæ•´æ„å»ºè„šæœ¬ç¤ºä¾‹

### 6.1 ä¸€é”®æ„å»ºè„šæœ¬ï¼ˆæ¨èä½¿ç”¨ï¼‰

åˆ›å»ºä»¥ä¸‹è„šæœ¬æ–‡ä»¶ `build_pdfium_and_project.sh`ï¼š

```bash
#!/bin/bash
set -e

echo "ğŸš€ å¼€å§‹æŒ‰é¡ºåºæ„å»ºï¼špdfium â†’ pdfium_ex â†’ PdfWinViewer"

# é¡¹ç›®æ ¹ç›®å½•
PROJECT_ROOT="/Users/wps/work/WorkSpace/github/PdfWinViewer"
PDFIUM_DIR="${PROJECT_ROOT}/third_party/pdfium"
PDFIUM_STATIC="${PDFIUM_DIR}/out/Debug/obj/libpdfium.a"

# ç¬¬ä¸€æ­¥ï¼šæ„å»º PDFium é™æ€åº“
echo "ğŸ“¦ ç¬¬ä¸€æ­¥ï¼šæ„å»º PDFium åŸºç¡€é™æ€åº“..."
cd "${PDFIUM_DIR}"

# æ¸…ç†å’Œå‡†å¤‡
rm -rf out/Debug
mkdir -p out/Debug

# åˆ›å»ºé…ç½®æ–‡ä»¶
cat > out/Debug/args.gn << 'EOF'
is_debug = true
symbol_level = 2
is_official_build = false
is_component_build = false
pdf_is_standalone = true
pdf_is_complete_lib = true
use_static_libs = true
use_custom_libcxx = false
use_system_freetype = false
use_system_libjpeg = false
use_system_libpng = false
use_system_zlib = false
pdf_use_skia = false
pdf_enable_xfa = false
pdf_enable_v8 = false
pdf_use_partition_alloc = false
target_os = "mac"
target_cpu = "arm64"
pdf_bundle_freetype = true
pdf_bundle_libjpeg = true
pdf_bundle_libpng = true
pdf_bundle_zlib = true
pdf_bundle_lcms2 = true
pdf_bundle_libopenjpeg2 = true
treat_warnings_as_errors = false
use_thin_lto = false
use_lld = false
link_pool_depth = 1
EOF

# ç”Ÿæˆæ„å»ºæ–‡ä»¶
echo "âš™ï¸  ç”Ÿæˆæ„å»ºæ–‡ä»¶..."
gn gen out/Debug

# æ„å»º PDFium
echo "ğŸ”¨ æ„å»º PDFium..."
ninja -C out/Debug pdfium

# ä¸¥æ ¼éªŒè¯æ„å»ºç»“æœå’Œè·¯å¾„
if [ ! -f "${PDFIUM_STATIC}" ]; then
    echo "âŒ PDFium æ„å»ºå¤±è´¥ï¼šé™æ€åº“æ–‡ä»¶ä¸åœ¨è¦æ±‚è·¯å¾„"
    echo "æœŸæœ›è·¯å¾„ï¼š${PDFIUM_STATIC}"
    echo "å½“å‰ç›®å½•ï¼š$(pwd)"
    exit 1
fi

# éªŒè¯è·¯å¾„çš„æ­£ç¡®æ€§
EXPECTED_RELATIVE_PATH="out/Debug/obj/libpdfium.a"
if [ ! -f "${EXPECTED_RELATIVE_PATH}" ]; then
    echo "âŒ é”™è¯¯ï¼šé™æ€åº“ä¸åœ¨PDFiumæºä»£ç ç›®å½•çš„æ­£ç¡®ä½ç½®"
    echo "å½“å‰ç›®å½•ï¼š$(pwd)"
    exit 1
fi

# éªŒè¯æˆ‘ä»¬åœ¨æ­£ç¡®çš„PDFiumç›®å½•
if [[ "$(pwd)" != *"third_party/pdfium" ]]; then
    echo "âŒ é”™è¯¯ï¼šä¸åœ¨æ­£ç¡®çš„PDFiumæºä»£ç ç›®å½•ä¸­"
    exit 1
fi

SIZE=$(stat -f%z "${PDFIUM_STATIC}")
echo "âœ… PDFium æ„å»ºæˆåŠŸï¼æ–‡ä»¶å¤§å°: $((SIZE / 1024 / 1024))MB"

# ç¬¬äºŒæ­¥ï¼šæ„å»º PDFium æ‰©å±•åº“ (pdfium_ex)
echo "ğŸ“š ç¬¬äºŒæ­¥ï¼šæ„å»º PDFium æ‰©å±•åº“..."
cd "${PROJECT_ROOT}/third_party/pdfium_ex"

# åˆ›å»ºæ„å»ºç›®å½•
rm -rf build
mkdir -p build && cd build

# é…ç½® pdfium_ex
echo "âš™ï¸  é…ç½® pdfium_ex..."
cmake .. -DCMAKE_BUILD_TYPE=Debug

# æ„å»º pdfium_ex
echo "ğŸ”¨ æ„å»º pdfium_ex..."
cmake --build . --config Debug

# éªŒè¯ pdfium_ex æ„å»ºç»“æœ
if [ ! -f "libpdfium_ex.a" ]; then
    echo "âŒ pdfium_ex æ„å»ºå¤±è´¥ï¼šé™æ€åº“æ–‡ä»¶ä¸å­˜åœ¨"
    exit 1
fi
echo "âœ… pdfium_ex æ„å»ºæˆåŠŸï¼"

# ç¬¬ä¸‰æ­¥ï¼šæ„å»ºä¸»é¡¹ç›® (PdfWinViewer)
echo "ğŸ—ï¸  ç¬¬ä¸‰æ­¥ï¼šæ„å»ºä¸»é¡¹ç›®..."
cd "${PROJECT_ROOT}"

# åˆ›å»ºæ„å»ºç›®å½•
rm -rf build
mkdir -p build && cd build

# é…ç½®ä¸»é¡¹ç›®
echo "âš™ï¸  é…ç½®ä¸»é¡¹ç›®..."
cmake .. -DCMAKE_BUILD_TYPE=Debug \
         -DPDFIUM_STATIC="${PDFIUM_STATIC}"

# æ„å»ºä¸»é¡¹ç›®
echo "ğŸ”¨ æ„å»ºä¸»é¡¹ç›®..."
cmake --build . --config Debug

# éªŒè¯æœ€ç»ˆç»“æœ
if [ -f "PdfWinViewer.app/Contents/MacOS/PdfWinViewer" ]; then
    echo "âœ… é¡¹ç›®æ„å»ºæˆåŠŸï¼"
    echo "ğŸ“± å¯æ‰§è¡Œæ–‡ä»¶: $(pwd)/PdfWinViewer.app/Contents/MacOS/PdfWinViewer"
    
    # éªŒè¯é“¾æ¥
    echo "ğŸ” éªŒè¯é“¾æ¥ä¾èµ–..."
    otool -L PdfWinViewer.app/Contents/MacOS/PdfWinViewer | grep -v "PDFium" || echo "âœ… ç¡®è®¤ï¼šPDFium å·²é™æ€é“¾æ¥"
else
    echo "âŒ ä¸»é¡¹ç›®æ„å»ºå¤±è´¥"
    exit 1
fi

echo "ğŸ‰ å…¨éƒ¨æ„å»ºå®Œæˆï¼"
```

### 6.2 ä½¿ç”¨è„šæœ¬

```bash
# ç»™è„šæœ¬æ‰§è¡Œæƒé™
chmod +x build_pdfium_and_project.sh

# æ‰§è¡Œæ„å»º
./build_pdfium_and_project.sh
```

**é‡è¦æé†’ï¼šæ­¤è„šæœ¬ä¸¥æ ¼éµå¾ªé¡¹ç›®ç°æœ‰è®¾è®¡ï¼Œä¸ä¼šä¿®æ”¹ä»»ä½•é¡¹ç›®æ–‡ä»¶ï¼**
